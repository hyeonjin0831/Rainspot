<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì”ê³  ìš”ì • (Balance Fairy)</title>
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom font fallback for Korean and general text */
    body {
      font-family: 'Inter', 'Pretendard', 'Noto Sans KR', sans-serif;
      min-height: 100vh;
    }

    /* Custom progress bar styles to match Tailwind philosophy */
    .progress-bar {
      transition: width 0.5s ease;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-content {
      background-color: white;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      max-width: 300px;
      width: 90%;
      text-align: center;
      transform: translateY(-20px);
      transition: transform 0.3s ease;
    }

    .modal-overlay.open .modal-content {
      transform: translateY(0);
    }

    #loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        font-size: 1.5rem;
        font-weight: 600;
    }
  </style>
</head>
<body class="bg-blue-50 flex flex-col items-center justify-center p-4">

  <!-- Loading Overlay -->
  <div id="loading-overlay">
    ë°ì´í„° ë¡œë”© ì¤‘...
  </div>
  
  <h1 class="text-4xl font-extrabold text-gray-800 mb-6 flex items-center">
    <span class="mr-2">ğŸ’°</span> ì”ê³  ìš”ì • (Balance Fairy)
  </h1>

  <div id="main-container" class="w-full max-w-sm bg-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition duration-300 ease-in-out transform hover:-translate-y-1">
    <p class="text-gray-600 mb-6 text-center text-sm">
      í•œ ë‹¬ ì˜ˆì‚°ì„ ì„¤ì •í•˜ê³  ì†Œë¹„ë¥¼ ê¸°ë¡í•˜ì—¬<br>ì‹¤ì‹œê°„ìœ¼ë¡œ ì˜ˆì‚° ì§„í–‰ ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”.
    </p>

    <!-- User ID Display -->
    <div class="text-xs text-gray-400 mb-4 text-left">
      User ID: <span id="user-id-display" class="font-mono text-gray-600 truncate">Connecting...</span>
    </div>

    <div class="space-y-4">
      <!-- Budget Input -->
      <div class="flex flex-col">
        <input type="number" id="budget-input" placeholder="ì˜ˆì‚° ê¸ˆì•¡ (ì›)" 
               class="p-3 border border-gray-300 rounded-xl focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition duration-150" />
        <button id="set-budget-btn" onclick="setBudget()" 
                class="w-full bg-blue-600 text-white font-semibold py-3 mt-2 rounded-xl hover:bg-blue-700 transition duration-200 shadow-md hover:shadow-lg">
          ì˜ˆì‚° ì„¤ì •
        </button>
      </div>

      <hr class="border-t border-gray-100 my-4">

      <!-- Expense Input -->
      <div class="flex flex-col">
        <input type="number" id="expense-input" placeholder="ì†Œë¹„ ê¸ˆì•¡ (ì›)" 
               class="p-3 border border-gray-300 rounded-xl focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition duration-150" />
        <button onclick="addExpense()" 
                class="w-full bg-green-500 text-white font-semibold py-3 mt-2 rounded-xl hover:bg-green-600 transition duration-200 shadow-md hover:shadow-lg">
          ì†Œë¹„ ì¶”ê°€
        </button>
      </div>
    </div>

    <!-- Progress Bar -->
    <div class="mt-6">
      <div class="h-6 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner">
        <div id="bar" class="progress-bar h-full" style="width: 0%;"></div>
      </div>
      <p id="status" class="mt-3 text-lg font-medium text-gray-700">ì˜ˆì‚°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
    </div>
    
    <!-- Reset Button -->
    <button onclick="resetMonth()" 
            class="w-full mt-6 bg-gray-300 text-gray-800 font-semibold py-3 rounded-xl hover:bg-gray-400 transition duration-200 shadow-md">
      ë¦¬ì…‹ (ìƒˆë¡œìš´ ë‹¬ ì‹œì‘)
    </button>
  </div>

  <!-- Custom Alert/Confirm Modal (Refactored) -->
  <div id="custom-modal" class="modal-overlay">
    <div class="modal-content">
      <p id="modal-message" class="text-gray-800 mb-4 font-medium"></p>
      
      <!-- Confirmation Buttons Group (Hidden by default for Alerts) -->
      <div id="modal-confirm-group" class="hidden space-x-4 justify-center">
        <!-- Cancel button is blue by default -->
        <button id="modal-cancel-btn" onclick="closeModal()" 
                class="bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-150">ì·¨ì†Œ</button>
        <!-- Confirm button is red (destructive/primary) -->
        <button id="modal-confirm-btn" 
                class="bg-red-600 text-white py-2 px-6 rounded-lg hover:bg-red-700 transition duration-150">í™•ì¸</button>
      </div>
      
      <!-- Alert Button (Default for simple messages) -->
      <button id="modal-alert-btn" onclick="closeModal()" 
              class="bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-150">í™•ì¸</button>
    </div>
  </div>

  <footer class="mt-8 text-sm text-gray-400">
    ì”ê³  ìš”ì • (Balance Fairy)
  </footer>

  <!-- Firebase Setup -->
  <script type="module">
    // --- Firebase Imports and Global Variables ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables for Firebase services
    let db;
    let auth;
    let userId = null;
    let budgetDocRef = null;
    let isInitialized = false;
    let unsubscribeSnapshot = null;

    // --- Data Variables (Global) ---
    window.budget = 0;
    window.total = 0;
    // Budget usage percentage thresholds for notifications
    window.thresholds = [10, 30, 50, 70, 90, 95];
    window.notified = window.thresholds.map(() => false);
    
    // --- Firestore Initialization and Authentication ---
    async function initFirebase() {
        try {
            document.getElementById('loading-overlay').style.display = 'flex';
            
            // 1. Get Config and App ID
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing.");
                throw new Error("Firebase configuration error.");
            }

            // 2. Initialize App and Services
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');
            
            // 3. Authentication
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            await new Promise(resolve => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        // Sign in using the provided token if available, otherwise anonymously
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                                console.error("Custom token sign-in failed, falling back to anonymous:", e);
                                return signInAnonymously(auth);
                            });
                        } else {
                            await signInAnonymously(auth);
                        }
                        // Re-run onAuthStateChanged to pick up the new user/uid
                        return; 
                    }
                    
                    document.getElementById('user-id-display').textContent = userId;
                    
                    // 4. Set Document Reference
                    const docPath = `artifacts/${appId}/users/${userId}/budget_data/state`;
                    budgetDocRef = doc(db, docPath);

                    // 5. Start Real-time Listener (onSnapshot)
                    startSnapshotListener();

                    isInitialized = true;
                    resolve();
                });
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            customAlert("ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
        } finally {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    }

    // Function to handle Real-time updates
    function startSnapshotListener() {
        if (unsubscribeSnapshot) {
            unsubscribeSnapshot(); // Stop previous listener if active
        }

        unsubscribeSnapshot = onSnapshot(budgetDocRef, (doc) => {
            if (doc.exists()) {
                const data = doc.data();
                window.budget = data.budget || 0;
                window.total = data.total || 0;
                // Safely merge stored notified state with current thresholds
                const storedNotified = data.notified || [];
                window.notified = window.thresholds.map((t, i) => storedNotified[i] || false);
                
                document.getElementById('budget-input').value = window.budget || '';
                updateUI();
            } else {
                // Document doesn't exist, set initial state
                window.budget = 0;
                window.total = 0;
                window.notified = window.thresholds.map(() => false);
                updateUI();
            }
        }, (error) => {
            console.error("Firestore snapshot error:", error);
            customAlert("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    }

    // --- Modal Functions (Refactored for Alert and Confirm) ---

    window.closeModal = function() {
      document.getElementById('custom-modal').classList.remove('open');
    }

    // Custom Modal implementation for simple messages (replaces alert())
    window.customAlert = function(message) {
      const modal = document.getElementById('custom-modal');
      document.getElementById('modal-message').textContent = message;
      
      // Configure for alert
      document.getElementById('modal-confirm-group').classList.add('hidden');
      document.getElementById('modal-alert-btn').classList.remove('hidden');
      
      modal.classList.add('open');
    }

    // Custom Modal implementation for confirmation (replaces confirm())
    window.customConfirm = function({ message, confirmText, cancelText, onConfirm, onCancel, isDestructive = false }) {
        const modal = document.getElementById('custom-modal');
        const confirmGroup = document.getElementById('modal-confirm-group');
        const confirmBtn = document.getElementById('modal-confirm-btn');
        const cancelBtn = document.getElementById('modal-cancel-btn');

        document.getElementById('modal-message').textContent = message;
        
        // Configure for confirmation
        document.getElementById('modal-alert-btn').classList.add('hidden');
        confirmGroup.classList.remove('hidden');
        confirmGroup.classList.add('flex'); // Ensure flex is applied when shown

        // Set button texts and styles
        confirmBtn.textContent = confirmText || "í™•ì¸";
        cancelBtn.textContent = cancelText || "ì·¨ì†Œ";
        
        // Apply destructive style if needed
        confirmBtn.classList.toggle('bg-red-600', isDestructive);
        confirmBtn.classList.toggle('hover:bg-red-700', isDestructive);
        confirmBtn.classList.toggle('bg-green-600', !isDestructive);
        confirmBtn.classList.toggle('hover:bg-green-700', !isDestructive);

        // Set up confirm action (Clone and replace to clear all previous listeners safely)
        const newConfirmBtn = confirmBtn.cloneNode(true); 
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn); 
        newConfirmBtn.onclick = () => {
            closeModal();
            onConfirm();
        };

        // Set up cancel action
        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        newCancelBtn.onclick = () => {
            closeModal();
            if (onCancel) onCancel();
        };

        modal.classList.add('open');
    }


    // --- Utility Functions ---

    window.saveToFirestore = async function() {
        if (!budgetDocRef || !isInitialized) return console.error("Firestore not ready.");
        
        try {
            // Save the entire state object to a single document
            await setDoc(budgetDocRef, {
                budget: window.budget,
                total: window.total,
                notified: window.notified,
                lastUpdate: new Date().toISOString()
            });
            console.log("Data saved to Firestore.");
        } catch (e) {
            console.error("Error writing document:", e);
            customAlert("ë°ì´í„° ì €ì¥ ì‹¤íŒ¨.");
        }
    }

    // New function to get customized notification messages
    function getThresholdMessage(percent, limit) {
        const limitStr = limit.toLocaleString();
        switch (percent) {
            case 10: return `ğŸ‘ ìˆœì¡°ë¡œìš´ ì‹œì‘! ì „ì²´ ì˜ˆì‚°ì˜ 10% (${limitStr}ì›)ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`;
            case 30: return `ğŸ’¡ 30% ë„ë‹¬! ì˜ˆì‚°ì˜ 3ë¶„ì˜ 1 (${limitStr}ì›)ì„ ì‚¬ìš©í–ˆì–´ìš”. ê³„íš ì ê²€ì´ í•„ìš”í•´ìš”.`;
            case 50: return `âš ï¸ ë°˜í™˜ì  í†µê³¼! ì˜ˆì‚°ì˜ ì ˆë°˜ (${limitStr}ì›)ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ë‚¨ì€ ê¸°ê°„ì„ í™•ì¸í•˜ì„¸ìš”.`;
            case 70: return `ğŸš¨ 70% ì£¼ì˜! ì˜ˆì‚°ì´ ë¹ ë¥´ê²Œ ì†Œì§„ë˜ê³  ìˆì–´ìš”. ì§€ì¶œì„ ì¡°ì ˆí•˜ì„¸ìš”!`;
            case 90: return `ğŸ”¥ ë¹„ìƒ! 90% (${limitStr}ì›)ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. ì´ë²ˆ ë‹¬ì€ ê±°ì˜ ëë‚¬ì–´ìš”!`;
            case 95: return `â›”ï¸ ë§ˆì§€ë§‰ ê²½ê³ ! ì˜ˆì‚°ì˜ 95% (${limitStr}ì›)ê°€ ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ì§€ì¶œì„ ë©ˆì¶°ì£¼ì„¸ìš”!`;
            default: return `ğŸš¨ ì˜ˆì‚° ì•Œë¦¼: ${percent}% (${limitStr}ì›) ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`;
        }
    }

    window.checkThresholds = function() {
        if (window.budget <= 0) return; // Cannot check thresholds without a budget

        window.thresholds.forEach((t, i) => {
            const limit = window.budget * (t / 100);
            if (window.total >= limit && !window.notified[i]) {
                const message = getThresholdMessage(t, limit);
                notifyUser(message);
                window.notified[i] = true;
                // Since notified state changed, save it
                window.saveToFirestore(); 
            }
        });
    }

    window.notifyUser = function(msg) {
        if (Notification.permission === "granted") {
            new Notification("ì”ê³  ìš”ì • ì•Œë¦¼", { // CHANGED: Updated notification title
                body: msg,
                icon: 'https://placehold.co/48x48/60a5fa/ffffff?text=%24'
            });
        } else {
            // Use custom modal instead of alert for non-granted notifications too
            customAlert(msg);
        }
    }

    window.updateUI = function() {
        const bar = document.getElementById('bar');
        const status = document.getElementById('status');
        if (!window.budget) {
            bar.style.width = "0%";
            status.innerText = "ì˜ˆì‚°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
            bar.classList.remove('bg-red-500');
            return;
        }

        const percent = (window.total / window.budget) * 100;
        const displayPercent = Math.min(percent, 100).toFixed(1);

        // Update progress bar width and color
        bar.style.width = displayPercent + "%";
        bar.classList.toggle('bg-red-600', percent > 100); // More vibrant red for overspending
        bar.classList.toggle('bg-blue-600', percent <= 100);

        const remaining = window.budget - window.total;
        
        if (remaining >= 0) {
             status.innerText = `ì´ ì†Œë¹„: ${window.total.toLocaleString()}ì› | ë‚¨ì€ ì˜ˆì‚°: ${remaining.toLocaleString()}ì› (${displayPercent}%)`;
             status.classList.remove('text-red-500');
             status.classList.add('text-gray-700');
        } else {
            status.innerText = `ğŸš¨ ì˜ˆì‚° ì´ˆê³¼: ${window.total.toLocaleString()}ì› | ì´ˆê³¼ ê¸ˆì•¡: ${(-remaining).toLocaleString()}ì› (${displayPercent}%)`;
            status.classList.add('text-red-500');
            status.classList.remove('text-gray-700');
        }
    }

    // --- Main Application Logic ---

    window.setBudget = function() {
        const inputElement = document.getElementById('budget-input');
        const value = parseInt(inputElement.value);

        if (isNaN(value) || value <= 0) {
            customAlert("âš ï¸ ì˜¬ë°”ë¥¸ ì˜ˆì‚° ê¸ˆì•¡ (ì–‘ìˆ˜)ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }
        
        const newBudget = value;

        const setBudgetHandler = (resetTotal = false) => {
            window.budget = newBudget;
            if (resetTotal) {
                window.total = 0;
            }
            window.notified = window.thresholds.map(() => false);
            window.saveToFirestore();
            customAlert(`âœ… ì˜ˆì‚° ${newBudget.toLocaleString()}ì›ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ` + (resetTotal ? "(ì†Œë¹„ ì´ˆê¸°í™”ë¨)" : "(ì†Œë¹„ ìœ ì§€ë¨)"));
        };

        // If there is existing expenditure, ask the user if they want to reset it.
        if (window.total > 0 && window.budget > 0) { 
            const message = `ìƒˆ ì˜ˆì‚° ${newBudget.toLocaleString()}ì›ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤. ê¸°ì¡´ ì†Œë¹„ ê¸°ë¡(ì´ ${window.total.toLocaleString()}ì›)ì„ ì´ˆê¸°í™”í• ê¹Œìš”?`;
            
            window.customConfirm({
                message: message,
                confirmText: "ì†Œë¹„ ì´ˆê¸°í™”",
                cancelText: "ì†Œë¹„ ìœ ì§€",
                onConfirm: () => setBudgetHandler(true),
                onCancel: () => setBudgetHandler(false),
                isDestructive: false // Not destructive, setting up future
            });
            
        } else {
            // No existing data or budget, just set it and reset total for cleanliness
            setBudgetHandler(true);
        }
    }

    window.addExpense = function() {
        if (!window.budget) {
            customAlert("âš ï¸ ë¨¼ì € ì˜ˆì‚°ì„ ì„¤ì •í•´ ì£¼ì„¸ìš”.");
            return;
        }

        const inputElement = document.getElementById('expense-input');
        const value = parseInt(inputElement.value);

        if (isNaN(value) || value <= 0) {
            customAlert("âš ï¸ ì†Œë¹„ ê¸ˆì•¡ (ì–‘ìˆ˜)ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        window.total += value;
        window.checkThresholds();
        window.saveToFirestore();
        inputElement.value = '';
    }

    window.resetMonth = function() {
        const resetAction = () => {
            window.budget = 0;
            window.total = 0;
            window.notified = window.thresholds.map(() => false);
            window.saveToFirestore(); 
            document.getElementById('budget-input').value = '';
            customAlert("ğŸ”„ ìƒˆë¡œìš´ ë‹¬ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        };

        window.customConfirm({
            message: "ì •ë§ë¡œ ëª¨ë“  ì˜ˆì‚° ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ê³  ìƒˆë¡œìš´ ë‹¬ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
            confirmText: "ì˜ˆ, ì´ˆê¸°í™”í•©ë‹ˆë‹¤",
            cancelText: "ì·¨ì†Œ",
            onConfirm: resetAction,
            isDestructive: true // This is a destructive action
        });
    }
    
    // --- Initial Setup Call ---
    document.addEventListener('DOMContentLoaded', () => {
        // Request notification permission immediately on load
        if (Notification.permission !== "granted") {
             Notification.requestPermission();
        }
        // Start Firebase initialization
        initFirebase();
    });

  </script>
</body>
</html>
